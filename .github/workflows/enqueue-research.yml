name: Enqueue Research Requests

on:
  push:
    paths:
      - 'ideas/**/*.md'
  workflow_dispatch:

concurrency:
  group: mylife-main-writes
  cancel-in-progress: false

jobs:
  enqueue:
    if: github.repository == 'h1rokun59/Mylife'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Enqueue ideas (4-step, heavy-aware)"
        env:
          BEFORE_SHA: ${{ github.event.before }}
          CURRENT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          echo "Repository: $GITHUB_REPOSITORY"
          echo "Before: ${BEFORE_SHA:-<none>}"
          echo "Current: ${CURRENT_SHA:-<none>}"

          if [ -z "${BEFORE_SHA:-}" ] || [ "${BEFORE_SHA}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git ls-files 'ideas/**/*.md' || true)
          else
            CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$CURRENT_SHA" -- 'ideas/**/*.md' || true)
          fi

          if [ -z "${CHANGED_FILES}" ]; then
            echo "No changed idea files."
            exit 0
          fi

          echo "Changed files:"
          echo "${CHANGED_FILES}"

          mkdir -p research-queue/pending
          QUEUE_CHANGED=false

          has_csv() {
            local csv="$1"
            local key="$2"
            echo ",${csv}," | tr '[:upper:]' '[:lower:]' | grep -q ",${key}," || return 1
            return 0
          }

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && { echo "Skipped (not found): $file"; continue; }

            echo "----------------------------------------"
            echo "Processing: $file"

            ACTIONS_LINE=$(grep -E '^\*\*Actions:\*\* ' "$file" || true)
            TAG_KEYS_LINE=$(grep -E '^\*\*TagKeys:\*\* ' "$file" || true)
            IDEA_ID_LINE=$(grep -E '^\*\*Idea-ID:\*\* ' "$file" || true)
            CREATED_UTC_LINE=$(grep -E '^\*\*Created-At-UTC:\*\* ' "$file" || true)
            CREATED_JST_LINE=$(grep -E '^\*\*Created-At-JST:\*\* ' "$file" || true)
            MODE_LINE=$(grep -E '^\*\*Mode:\*\* ' "$file" || true)

            ACTIONS=$(echo "$ACTIONS_LINE" | sed -E 's/^\*\*Actions:\*\* //')
            TAG_KEYS=$(echo "$TAG_KEYS_LINE" | sed -E 's/^\*\*TagKeys:\*\* //')
            IDEA_ID=$(echo "$IDEA_ID_LINE" | sed -E 's/^\*\*Idea-ID:\*\* //')
            CREATED_AT_UTC=$(echo "$CREATED_UTC_LINE" | sed -E 's/^\*\*Created-At-UTC:\*\* //')
            CREATED_AT_JST=$(echo "$CREATED_JST_LINE" | sed -E 's/^\*\*Created-At-JST:\*\* //')
            MODE_HINT=$(echo "$MODE_LINE" | sed -E 's/^\*\*Mode:\*\* //')

            echo "ModeHint: ${MODE_HINT:-<none>}"
            echo "Actions: ${ACTIONS:-<none>}"
            echo "TagKeys: ${TAG_KEYS:-<none>}"
            echo "Idea-ID: ${IDEA_ID:-<none>}"

            HAS_RESEARCH=false
            HAS_HEAVY=false

            if has_csv "${ACTIONS}" "research"; then HAS_RESEARCH=true; fi
            if has_csv "${ACTIONS}" "heavy"; then HAS_HEAVY=true; fi

            # heavyã ã‘ã§ã‚‚researchæ‰±ã„ã«ã™ã‚‹
            if [ "$HAS_HEAVY" = true ] && [ "$HAS_RESEARCH" = false ]; then
              HAS_RESEARCH=true
              if [ -z "${ACTIONS}" ]; then ACTIONS="research"; else ACTIONS="${ACTIONS},research"; fi
            fi

            if [ "$HAS_RESEARCH" != true ]; then
              echo "No research action. Skip."
              continue
            fi

            EXECUTION_MODE="normal"
            if echo "${MODE_HINT:-}" | tr '[:upper:]' '[:lower:]' | grep -q '^super-heavy$'; then
              EXECUTION_MODE="super-heavy"
            elif [ "$HAS_HEAVY" = true ]; then
              EXECUTION_MODE="super-heavy"
            fi

            # Idea-ID fallback
            if [ -z "${IDEA_ID}" ]; then
              IDEA_ID="$(basename "$file" .md)"
              echo "Fallback Idea-ID: ${IDEA_ID}"
            fi

            TITLE=$(grep -m1 '^# ' "$file" | sed 's/^# //')
            [ -z "$TITLE" ] && TITLE="(untitled idea)"

            BODY_SNIPPET=$(
              awk '
                /^---$/ { next }
                /^\*Captured via Idea Capture App\*$/ { next }
                /^# / { next }
                /^\*\*[A-Za-z0-9-]+:\*\* / { next }
                /^[[:space:]]*$/ { next }
                { print; exit }
              ' "$file"
            )

            ENQUEUED_AT_UTC="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            SOURCE_URL="https://github.com/${GITHUB_REPOSITORY}/blob/${CURRENT_SHA}/${file}"
            QUEUE_PATH="research-queue/pending/${IDEA_ID}.json"

            # 4-step methodology
            STEPS_JSON='["step1","step2","step3","step4"]'
            METH_NAME="four-step"
            METH_VERSION=1

            # execution config
            PROVIDERS_ALLOWED='["gemini"]'
            PROVIDERS_PRIMARY="gemini"
            EXEC_STRATEGY="sequential"
            EXEC_PARALLELISM=1
            COOLDOWN_MIN=15
            ONE_STEP_PER_RUN=true

            if [ "$EXECUTION_MODE" = "super-heavy" ]; then
              PROVIDERS_ALLOWED='["gemini","claude","chatgpt"]'
              PROVIDERS_PRIMARY="claude"
              EXEC_STRATEGY="stepwise-parallel"
              EXEC_PARALLELISM=3
              COOLDOWN_MIN=0
              ONE_STEP_PER_RUN=false
            fi

            jq -n \
              --argjson queue_version 1 \
              --arg status "pending" \
              --arg task_type "openclaw_research" \
              --arg requested_action "research" \
              --arg idea_id "$IDEA_ID" \
              --arg execution_mode "$EXECUTION_MODE" \
              --arg orchestrator "claude-code" \
              --arg exec_strategy "$EXEC_STRATEGY" \
              --argjson exec_parallelism "$EXEC_PARALLELISM" \
              --argjson cooldown_minutes "$COOLDOWN_MIN" \
              --argjson one_step_per_run "$ONE_STEP_PER_RUN" \
              --arg providers_allowed_json "$PROVIDERS_ALLOWED" \
              --arg providers_primary "$PROVIDERS_PRIMARY" \
              --argjson meth_version "$METH_VERSION" \
              --arg meth_name "$METH_NAME" \
              --arg steps_json "$STEPS_JSON" \
              --arg source_repo "$GITHUB_REPOSITORY" \
              --arg source_path "$file" \
              --arg source_commit_sha "$CURRENT_SHA" \
              --arg source_url "$SOURCE_URL" \
              --arg title "$TITLE" \
              --arg body_snippet "$BODY_SNIPPET" \
              --arg tag_keys "$TAG_KEYS" \
              --arg actions "$ACTIONS" \
              --arg created_at_utc "$CREATED_AT_UTC" \
              --arg created_at_jst "$CREATED_AT_JST" \
              --arg enqueued_at_utc "$ENQUEUED_AT_UTC" \
              '{
                queue_version: $queue_version,
                status: $status,
                task_type: $task_type,
                requested_action: $requested_action,
                idea_id: $idea_id,

                execution: {
                  mode: $execution_mode,
                  orchestrator: $orchestrator,
                  strategy: $exec_strategy,
                  parallelism: $exec_parallelism,
                  one_step_per_run: $one_step_per_run,
                  cooldown_minutes_between_steps: $cooldown_minutes,
                  providers: {
                    allowed: ($providers_allowed_json | fromjson),
                    primary: $providers_primary
                  }
                },

                methodology: {
                  name: $meth_name,
                  version: $meth_version,
                  steps: ($steps_json | fromjson)
                },

                state: {
                  status: "queued",
                  current_step: "step1",
                  completed_steps: [],
                  next_eligible_at_utc: $enqueued_at_utc
                },

                source: {
                  repo: $source_repo,
                  path: $source_path,
                  commit_sha: $source_commit_sha,
                  url: $source_url
                },

                idea: {
                  title: $title,
                  body_snippet: (if $body_snippet == "" then null else $body_snippet end),
                  tag_keys: ($tag_keys | split(",") | map(select(length > 0))),
                  actions: ($actions | split(",") | map(select(length > 0))),
                  created_at_utc: (if $created_at_utc == "" then null else $created_at_utc end),
                  created_at_jst: (if $created_at_jst == "" then null else $created_at_jst end)
                },

                enqueue: {
                  enqueued_at_utc: $enqueued_at_utc,
                  trigger: "github_actions",
                  workflow: "enqueue-research.yml"
                }
              }' > "$QUEUE_PATH"

            echo "Wrote queue file: $QUEUE_PATH"
            QUEUE_CHANGED=true

          done <<< "$CHANGED_FILES"

          if [ "$QUEUE_CHANGED" != "true" ]; then
            echo "No research queue entries generated."
            exit 0
          fi

          if [ -z "$(git status --porcelain -- research-queue)" ]; then
            echo "No effective changes under research-queue."
            exit 0
          fi

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add research-queue
          git commit -m "ðŸ§  enqueue research requests (4-step, heavy-aware)" || echo "Nothing to commit."

          for i in 1 2 3; do
            echo "Push attempt $i..."
            git fetch origin main
            if git rebase origin/main; then
              if git push; then
                echo "Push succeeded."
                break
              fi
            else
              git rebase --abort || true
            fi
            sleep $((i * 2))
          done