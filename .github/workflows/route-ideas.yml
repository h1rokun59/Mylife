name: Route Ideas by Tag

on:
  push:
    paths:
      - 'ideas/**/*.md'

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Route to target repository
        env:
          ROUTER_PAT: ${{ secrets.ROUTER_PAT }}
        run: |
          git show --name-only --format="" HEAD | grep '^ideas/.*\.md$' | while read file; do
            echo "Processing: $file"
            TAGS=$(grep '^\*\*Tags:\*\*' "$file" || echo "")
            echo "Tags found: $TAGS"
            IS_PRO=false
            IS_LIFE=false
            if echo "$TAGS" | grep -qE "Resilience|SOC|Threat|Cloud|AI|Architecture|People|Process"; then
              IS_PRO=true
            fi
            if echo "$TAGS" | grep -qE "Ski|Hiking|Camp|Bike|Rural|Life|Random"; then
              IS_LIFE=true
            fi
            echo "IS_PRO: $IS_PRO, IS_LIFE: $IS_LIFE"
            for TARGET_REPO in $([ "$IS_PRO" = true ] && echo "SOC-Modernization") $([ "$IS_LIFE" = true ] && echo "Mylife"); do
              echo "Routing to: $TARGET_REPO"
              git clone https://x-access-token:${ROUTER_PAT}@github.com/h1rokun59/${TARGET_REPO}.git /tmp/${TARGET_REPO}
              mkdir -p /tmp/${TARGET_REPO}/${file%/*}
              cp "$file" /tmp/${TARGET_REPO}/${file}
              cd /tmp/${TARGET_REPO}
              git config user.email "actions@github.com"
              git config user.name "GitHub Actions"
              git add .
              git commit -m "ðŸ’¡ routed: $(basename $file)"
              git push
              cd -
            done
          done
