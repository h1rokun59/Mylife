name: Route Ideas by Tag

on:
  push:
    paths:
      - 'ideas/**/*.md'

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Route to target repository
        env:
          ROUTER_PAT: ${{ secrets.ROUTER_PAT }}
        run: |
          git diff --name-only HEAD~1 HEAD | grep '^ideas/.*\.md$' | while read file; do
            echo "Processing: $file"
            
            # „Çø„Ç∞Ë°å„ÇíÂèñÂæó
            TAGS=$(grep '^\*\*Tags:\*\*' "$file" || echo "")
            echo "Tags: $TAGS"
            
            # ÊåØ„ÇäÂàÜ„ÅëÂÖà„ÇíÊ±∫ÂÆö
            TARGET_REPO=""
            if echo "$TAGS" | grep -qE "Resilience|SOC|Threat Intel|Cloud|AI/ML|Architecture|People|Process"; then
              TARGET_REPO="SOC-Modernization"
            elif echo "$TAGS" | grep -qE "Ski|Hiking|Camp|Bike|Rural|Life|Random"; then
              TARGET_REPO="Mylife"
            fi
            
            if [ -z "$TARGET_REPO" ]; then
              echo "No matching tag found, skipping."
              continue
            fi
            
            echo "Routing to: $TARGET_REPO"
            
            # „Çø„Éº„Ç≤„ÉÉ„Éà„É™„Éù„Ç∏„Éà„É™„Å´„Ç≥„Éî„Éº
            git clone https://x-access-token:${ROUTER_PAT}@github.com/h1rokun59/${TARGET_REPO}.git /tmp/${TARGET_REPO}
            
            mkdir -p /tmp/${TARGET_REPO}/${file%/*}
            cp "$file" /tmp/${TARGET_REPO}/${file}
            
            cd /tmp/${TARGET_REPO}
            git config user.email "actions@github.com"
            git config user.name "GitHub Actions"
            git add .
            git commit -m "üí° routed: $(basename $file)"
            git push
            cd -
          done
