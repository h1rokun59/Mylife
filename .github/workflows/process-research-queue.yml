name: Process Research Queue (Dummy Worker)

on:
  push:
    paths:
      - 'research-queue/pending/*.json'
  workflow_dispatch:

jobs:
  process:
    if: github.repository == 'h1rokun59/Mylife' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "Process pending research queue files"
        env:
          BEFORE_SHA: ${{ github.event.before }}
          CURRENT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          echo "Repository: $GITHUB_REPOSITORY"
          echo "Before: ${BEFORE_SHA:-<none>}"
          echo "Current: ${CURRENT_SHA:-<none>}"

          # Â§âÊõ¥„Åï„Çå„Åü pending queue „Éï„Ç°„Ç§„É´„ÇíÂèñÂæóÔºàÂàùÂõû/ÁâπÊÆä„Ç±„Éº„Çπ„Å´„ÇÇÂØæÂøúÔºâ
          if [ -z "${BEFORE_SHA:-}" ] || [ "${BEFORE_SHA}" = "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git ls-files 'research-queue/pending/*.json' || true)
          else
            CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$CURRENT_SHA" -- 'research-queue/pending/*.json' || true)
          fi

          if [ -z "${CHANGED_FILES}" ]; then
            echo "No changed pending queue files."
            exit 0
          fi

          echo "Changed queue files:"
          echo "${CHANGED_FILES}"

          mkdir -p research-results
          mkdir -p research-queue/processed

          ANY_PROCESSED=false

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # ÂâäÈô§„Ç§„Éô„É≥„Éà„Å™„Å©„ÅßÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if [ ! -f "$file" ]; then
              echo "Skipped (not found): $file"
              continue
            fi

            echo "----------------------------------------"
            echo "Processing queue file: $file"

            STATUS=$(jq -r '.status // ""' "$file")
            IDEA_ID=$(jq -r '.idea_id // ""' "$file")
            TASK_TYPE=$(jq -r '.task_type // ""' "$file")
            REQUESTED_ACTION=$(jq -r '.requested_action // ""' "$file")

            SOURCE_REPO=$(jq -r '.source.repo // ""' "$file")
            SOURCE_PATH=$(jq -r '.source.path // ""' "$file")
            SOURCE_URL=$(jq -r '.source.url // ""' "$file")
            SOURCE_COMMIT=$(jq -r '.source.commit_sha // ""' "$file")

            TITLE=$(jq -r '.idea.title // ""' "$file")
            BODY_SNIPPET=$(jq -r '.idea.body_snippet // ""' "$file")
            CREATED_AT_UTC=$(jq -r '.idea.created_at_utc // ""' "$file")
            CREATED_AT_JST=$(jq -r '.idea.created_at_jst // ""' "$file")

            TAG_KEYS_CSV=$(jq -r '(.idea.tag_keys // []) | join(",")' "$file")
            ACTIONS_CSV=$(jq -r '(.idea.actions // []) | join(",")' "$file")

            echo "Status: ${STATUS:-<none>}"
            echo "Idea-ID: ${IDEA_ID:-<none>}"
            echo "Task: ${TASK_TYPE:-<none>} / ${REQUESTED_ACTION:-<none>}"

            if [ "$STATUS" != "pending" ]; then
              echo "Skip: status is not pending."
              continue
            fi

            if [ -z "$IDEA_ID" ]; then
              IDEA_ID="$(basename "$file" .json)"
              echo "Fallback Idea-ID: $IDEA_ID"
            fi

            if [ -z "$TITLE" ]; then
              TITLE="(untitled idea)"
            fi

            PROCESSED_AT_UTC="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            RESULT_PATH="research-results/${IDEA_ID}.md"
            PROCESSED_QUEUE_PATH="research-queue/processed/${IDEA_ID}.json"

            # „ÉÄ„Éü„ÉºÁµêÊûúÔºàOpenClawÊé•Á∂öÂâç„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄÔºâ
            cat > "$RESULT_PATH" <<EOF
          # üîé Research Result (Dummy)

          **Idea-ID:** ${IDEA_ID}
          **Status:** done (dummy worker)
          **Processed-At-UTC:** ${PROCESSED_AT_UTC}

          ## Source
          - **Repo:** ${SOURCE_REPO}
          - **Path:** ${SOURCE_PATH}
          - **Commit:** ${SOURCE_COMMIT}
          - **URL:** ${SOURCE_URL}

          ## Idea Metadata
          - **Title:** ${TITLE}
          - **TagKeys:** ${TAG_KEYS_CSV}
          - **Actions:** ${ACTIONS_CSV}
          - **Created-At-UTC:** ${CREATED_AT_UTC}
          - **Created-At-JST:** ${CREATED_AT_JST}

          ## Snippet
          ${BODY_SNIPPET:-"(no snippet)"}

          ## Dummy Analysis Summary
          - This is a placeholder result generated by GitHub Actions.
          - Queue ingestion and processing pipeline is working.
          - Next step: replace this dummy worker with OpenClaw execution.

          ## Suggested Next Research Plan
          1. Clarify the research question and expected output format
          2. Gather primary sources and recent references
          3. Summarize findings with citations
          4. Save structured output for follow-up automation
          EOF

            # processed queue JSON „Çí‰ΩúÊàêÔºàÂÖÉ„Éï„Ç°„Ç§„É´„ÇíÊõ¥Êñ∞„Åó„Å¶ pending „Åã„ÇâÁßªÂãïÔºâ
            jq \
              --arg processed_at_utc "$PROCESSED_AT_UTC" \
              --arg result_path "$RESULT_PATH" \
              --arg worker_name "github-actions-dummy-worker" \
              --arg worker_version "1" \
              '
              .status = "done"
              | .process = {
                  processed_at_utc: $processed_at_utc,
                  worker: {
                    name: $worker_name,
                    version: ($worker_version | tonumber)
                  },
                  mode: "dummy"
                }
              | .result = {
                  path: $result_path,
                  summary: "Dummy result created by GitHub Actions"
                }
              ' "$file" > "$PROCESSED_QUEUE_PATH"

            # pending „Åã„ÇâÂâäÈô§ÔºàgitÁÆ°ÁêÜ‰∏ã„ÅÆÂâäÈô§Ôºâ
            git rm -f "$file"

            echo "Created result: $RESULT_PATH"
            echo "Moved queue to processed: $PROCESSED_QUEUE_PATH"

            ANY_PROCESSED=true
          done <<< "$CHANGED_FILES"

          if [ "$ANY_PROCESSED" != "true" ]; then
            echo "No queue items processed."
            exit 0
          fi

          # Â§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Ç≥„Éü„ÉÉ„ÉàÔºàuntracked„ÇÇÂê´„ÇÅ„Å¶Âà§ÂÆöÔºâ
          if [ -z "$(git status --porcelain -- research-queue research-results)" ]; then
            echo "No effective changes to commit."
            exit 0
          fi

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add research-queue research-results
          git commit -m "ü§ñ process research queue (dummy worker)"
          git push