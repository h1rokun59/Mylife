name: Process Research Queue (Dummy Worker)

on:
  workflow_run:
    workflows: ["Enqueue Research Requests"]
    types: [completed]
  workflow_dispatch:

jobs:
  process:
    if: github.repository == 'h1rokun59/Mylife' && (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: "Process all pending research queue files"
        run: |
          set -euo pipefail

          echo "Repository: $GITHUB_REPOSITORY"
          echo "Event: $GITHUB_EVENT_NAME"

          PENDING_FILES=$(git ls-files 'research-queue/pending/*.json' || true)
          if [ -z "${PENDING_FILES}" ]; then
            echo "No pending queue files."
            exit 0
          fi

          echo "Pending queue files:"
          echo "${PENDING_FILES}"

          mkdir -p research-results
          mkdir -p research-queue/processed

          ANY_PROCESSED=false

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && { echo "Skipped (not found): $file"; continue; }

            echo "----------------------------------------"
            echo "Processing queue file: $file"

            STATUS=$(jq -r '.status // ""' "$file")
            IDEA_ID=$(jq -r '.idea_id // ""' "$file")

            SOURCE_REPO=$(jq -r '.source.repo // ""' "$file")
            SOURCE_PATH=$(jq -r '.source.path // ""' "$file")
            SOURCE_URL=$(jq -r '.source.url // ""' "$file")
            SOURCE_COMMIT=$(jq -r '.source.commit_sha // ""' "$file")

            TITLE=$(jq -r '.idea.title // ""' "$file")
            BODY_SNIPPET=$(jq -r '.idea.body_snippet // ""' "$file")
            CREATED_AT_UTC=$(jq -r '.idea.created_at_utc // ""' "$file")
            CREATED_AT_JST=$(jq -r '.idea.created_at_jst // ""' "$file")

            TAG_KEYS_CSV=$(jq -r '(.idea.tag_keys // []) | join(",")' "$file")
            ACTIONS_CSV=$(jq -r '(.idea.actions // []) | join(",")' "$file")

            echo "Status: ${STATUS:-<none>}"
            echo "Idea-ID: ${IDEA_ID:-<none>}"

            if [ "$STATUS" != "pending" ]; then
              echo "Skip: status is not pending."
              continue
            fi

            if [ -z "$IDEA_ID" ]; then
              IDEA_ID="$(basename "$file" .json)"
              echo "Fallback Idea-ID: $IDEA_ID"
            fi

            if [ -z "$TITLE" ]; then
              TITLE="(untitled idea)"
            fi

            PROCESSED_AT_UTC="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            RESULT_PATH="research-results/${IDEA_ID}.md"
            PROCESSED_QUEUE_PATH="research-queue/processed/${IDEA_ID}.json"

                        cat > "$RESULT_PATH" <<EOF
            # ðŸ”Ž Research Result (Dummy)

            **Idea-ID:** ${IDEA_ID}
            **Status:** done (dummy worker)
            **Processed-At-UTC:** ${PROCESSED_AT_UTC}

            ## Source
            - **Repo:** ${SOURCE_REPO}
            - **Path:** ${SOURCE_PATH}
            - **Commit:** ${SOURCE_COMMIT}
            - **URL:** ${SOURCE_URL}

            ## Idea Metadata
            - **Title:** ${TITLE}
            - **TagKeys:** ${TAG_KEYS_CSV}
            - **Actions:** ${ACTIONS_CSV}
            - **Created-At-UTC:** ${CREATED_AT_UTC}
            - **Created-At-JST:** ${CREATED_AT_JST}

            ## Snippet
            ${BODY_SNIPPET:-"(no snippet)"}

            ## Dummy Analysis Summary
            - This is a placeholder result generated by GitHub Actions.
            - Queue ingestion and processing pipeline is working.
            - Next step: replace this dummy worker with OpenClaw execution.

            ## Suggested Next Research Plan
            1. Clarify the research question and expected output format
            2. Gather primary sources and recent references
            3. Summarize findings with citations
            4. Save structured output for follow-up automation
            EOF

            jq \
              --arg processed_at_utc "$PROCESSED_AT_UTC" \
              --arg result_path "$RESULT_PATH" \
              --arg worker_name "github-actions-dummy-worker" \
              --arg worker_version "1" \
              '
              .status = "done"
              | .process = {
                  processed_at_utc: $processed_at_utc,
                  worker: {
                    name: $worker_name,
                    version: ($worker_version | tonumber)
                  },
                  mode: "dummy"
                }
              | .result = {
                  path: $result_path,
                  summary: "Dummy result created by GitHub Actions"
                }
              ' "$file" > "$PROCESSED_QUEUE_PATH"

            git rm -f "$file"

            echo "Created result: $RESULT_PATH"
            echo "Moved queue to processed: $PROCESSED_QUEUE_PATH"

            ANY_PROCESSED=true
          done <<< "$PENDING_FILES"

          if [ "$ANY_PROCESSED" != "true" ]; then
            echo "No queue items processed."
            exit 0
          fi

          if [ -z "$(git status --porcelain -- research-queue research-results)" ]; then
            echo "No effective changes to commit."
            exit 0
          fi
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add research-queue research-results
          git commit -m "ðŸ¤– process research queue (dummy worker)"
          git push